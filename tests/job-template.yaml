apiVersion: batch/v1
kind: Job
metadata:
  name: 2023-07-02-configure-rke-node-19mv
  namespace: {{ .Namespace }}
  labels:
    app: machine-shop-operator
    machine-shop-operator: ansible
spec:
  template:
    metadata:
      name: 2023-07-02-configure-rke-node-19mv
      labels:
        app: machine-shop-operator
        machine-shop-operator: ansible
    spec:
      containers:
        - name: manager
          image: eu.gcr.io/stuttgart-things/sthings-ansible:8.0.0-4
          imagePullPolicy: Always
          securityContext:
            allowPrivilegeEscalation: true
            privileged: true
            runAsNonRoot: true
            readOnlyRootFilesystem: false
            runAsUser: 65532
          env:
            - name: ANSIBLE_HOST_KEY_CHECKING
              value: "False"
            - name: INV_PATH
              value: "/tmp/inv"
            - name: TARGETS
              value: "mso-vm2.tiab.labda.sva.de"
          envFrom:
            - secretRef:
                name: vault
          resources:
            requests:
              cpu: 150m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 768Mi
          command:
            - /bin/sh
            - -ec
            - touch ${INV_PATH} && ansible-playbook -i $INV_PATH $HOME/ansible/play.yaml -vv -e prepare_env=true -e execute_baseos=true -e target_play=configure-rke-node
          volumeMounts:
            - name: ansible
              mountPath: /home/nonroot/ansible
      restartPolicy: Never
      volumes:
        - name: ansible
          configMap:
            name: ansible
